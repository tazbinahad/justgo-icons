trigger:
  - CICD

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: Build
    displayName: "Build and Verify"
    jobs:
      - job: Build
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "20.x"
            displayName: "Install Node.js"

          - script: |
              npm install -g yarn
              yarn install --frozen-lockfile
            displayName: "Install dependencies (Yarn)"

          - script: |
              yarn build
            displayName: "Build Library"

          - script: |
              yarn build-docs
            displayName: "Build Docs Site"

          # Publish Docs files for the Deploy stage
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "docs-dist"
              ArtifactName: "docs"
              publishLocation: "Container"
            displayName: "Publish Docs Artifact"

          # Prepare files for the PublishNpm stage
          - task: CopyFiles@2
            inputs:
              SourceFolder: "$(System.DefaultWorkingDirectory)"
              Contents: |
                package.json
                README.md
                .npmrc
                dist/**
                scripts/**
                Icons.json
                src/**
              TargetFolder: "$(Build.ArtifactStagingDirectory)/npm-package"
            displayName: "Stage Package Files"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)/npm-package"
              ArtifactName: "npm-package"
              publishLocation: "Container"
            displayName: "Publish Package Artifact"

  - stage: DeployDocs
    displayName: "Deploy Docs"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployWeb
        displayName: "Deploy to Web"
        environment: "storybook-live"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: docs

                # OPTION 1: Azure Static Web Apps
                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: "$(Pipeline.Workspace)/docs"
                    skip_app_build: true
                    skip_api_build: true
                    azure_static_web_apps_api_token: $(deployment_token)
                  displayName: "Deploy to Azure Static Web Apps"

                # OPTION 2: Azure App Service (Placeholder)
                # - task: AzureRmWebAppDeployment@4
                #   inputs: ...

  - stage: PublishNpm
    displayName: "Publish to npm"
    dependsOn: DeployDocs
    condition: succeeded()
    jobs:
      - deployment: NPM_Release
        displayName: "Release to npm"
        environment: "npm-release" # <--- THIS ENFORCES MANUAL APPROVAL IN AZURE
        strategy:
          runOnce:
            deploy:
              steps:
                - task: NodeTool@0
                  inputs:
                    versionSpec: "20.x"
                  displayName: "Install Node.js"

                - task: npmAuthenticate@0
                  inputs:
                    workingFile: "$(Pipeline.Workspace)/npm-package/.npmrc"
                  displayName: "Authenticate with Azure Artifacts"

                - script: |
                    cd $(Pipeline.Workspace)/npm-package
                    npm publish
                  displayName: "Publish to Azure Artifacts"
